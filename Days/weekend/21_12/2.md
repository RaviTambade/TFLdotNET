# *From Home â†’ Privacy â†’ Products â†’ Add to Cart (Understanding Async, MVC & URLs)*

### ğŸ§­ **Letâ€™s Start Where Every MVC App Starts**

I tell students:

> â€œLet us understand the flow of asp.net core mvc application


Open the browser.

You see:

* **Home**
* **Privacy**

These links come from where?

ğŸ‘‰ `_Layout.cshtml`

## ğŸ§© `_Layout.cshtml` â€“ The Common Backbone

* Header
* Navigation
* Footer
* Shared UI

When you click:

* Home
* Privacy

You are actually calling:

* `HomeController`
* Action methods inside it

This is **MVC routing in action**.

## ğŸ  HomeController â€“ Default Thinking

Now open **HomeController**.

Youâ€™ll see:

```csharp
public IActionResult Index()
public IActionResult Privacy()
```

Sometimes youâ€™ll also see:

```csharp
public async Task<IActionResult> Privacy()
```

Now pause.

## ğŸ§  Blocking vs Non-Blocking (Mentor Analogy)

I ask students:

> â€œImagine I am teachingâ€¦
> and I suddenly feel thirsty.â€

Two options:

âŒ Stop the lecture and go drink water
âœ… Ask Sahil: â€œPlease bring me waterâ€

What happens in second case?

* Lecture continues
* Request is sent
* Water comes later
* No one is blocked

ğŸ‘‰ **That is asynchronous programming**

## ğŸ” Async in ASP.NET Core

When you write:

```csharp
public async Task<IActionResult> Privacy()
```

You are saying:

* Donâ€™t block the request thread
* Let the server handle other requests
* Resume when work is done

This uses:

* **Task Parallel Library**
* Non-blocking I/O

Production-ready applications **must** use this pattern.

## ğŸ§  Promise Handling (Industry Term)

In JavaScript they call it **Promise**
In .NET we call it **Task**

Same philosophy:

> â€œResult will come later, donâ€™t wait idle.â€

## ğŸ›’ Moving to Products â€“ Real Business Flow

Now we move from:

* Home
* Privacy

To:

* **Products**

Click **Products**.


### ğŸ“¦ ProductsController

Inside:

```csharp
public IActionResult Index()
```

Or:

```csharp
public async Task<IActionResult> Index()
```

Here:

* Data is fetched from DB
* Using Repository pattern
* Using Entity Framework

We donâ€™t deep-dive there now.

Focus is **feature flow**.

## ğŸ–¥ï¸ Products.cshtml â€“ UI Speaks

Open `Products.cshtml`.

Youâ€™ll see:

* Bootstrap cards
* Product name
* Price
* Buttons:

  * **Buy Now**
  * **Add to Cart**

Now comes the **real moment**.

## ğŸ”— Click â€œAdd to Cartâ€ â€“ Observe the URL

I ask students:

> â€œDonâ€™t look at UIâ€¦
> Look at the **URL**.â€

When you click **Add to Cart**, URL becomes something like:

```
/ShoppingCart/AddToCart/3
```

Now ask yourself:

â“ Do we have:

* ShoppingCartController?
* AddToCart action method?

ğŸ‘‰ **No**


## ğŸš¨ This Is Not a Bug â€“ This Is Design in Progress

This is **exactly where feature development starts**.

We are:

* Redirecting to an endpoint
* Which is not yet implemented

Why?

Because:

* User story demands it
* Acceptance criteria expects it
* Test cases will validate it

## ğŸ§  Route Thinking

The URL tells us everything:

```
ShoppingCart / AddToCart / ProductId
```

So we need:

1ï¸âƒ£ `ShoppingCartController`
2ï¸âƒ£ `AddToCart(int productId)` action
3ï¸âƒ£ Logic to add product to cart

## ğŸ“‹ Mapping to User Story

User story says:

> As a user,
> I want to add items to my shopping cart
> so that I can purchase them later.

Acceptance criteria:

* Product ID must be passed
* Cart must store item
* User should see updated cart

## ğŸ§ª Test Driven Thinking

Before coding, test case exists:

* Click â€œAdd to Cartâ€
* Expected:

  * Item added
  * Cart count updated

Right now:

* Test âŒ fails
* Because feature not implemented

And thatâ€™s **perfect**.

## ğŸ§  Bottom-Up Understanding

So what are we doing now?

* UI already ready
* URL already defined
* User story already clear
* Test case already known

Now developerâ€™s job is:

> **Fill the missing piece correctly**

## ğŸ—ï¸ What Comes Next (Implementation Plan)

1ï¸âƒ£ Create `ShoppingCartController`
2ï¸âƒ£ Inject `IShoppingCartService`
3ï¸âƒ£ Implement `AddToCart(int id)`
4ï¸âƒ£ Update session/cart
5ï¸âƒ£ Redirect to cart view


## ğŸ§  Mentorâ€™s Final Thought

> â€œGreat developers donâ€™t start with code.
> They start by **observing flow**.â€

> â€œURL tells the story.
> Controller fulfills it.
> Service implements it.â€

This is **real application development**, not tutorials.




# *Session-Based Shopping Cart â€“ Keeping State in a Stateless World*

### ğŸ§  **First, the Big Truth**

I always start with this line:

> **â€œWeb applications are stateless by default.â€**

Every HTTP request:

* Comes alone
* Goes alone
* Server forgets everything after response

Now student asks:

> â€œSir, mag shopping cart kasa kaam karta?â€
> How does cart remember items?

ğŸ‘‰ Answer: **Session**

## ğŸ§  Real-Life Analogy

Think of a hotel:

* You enter â†’ reception gives you a **room key**
* You go out â†’ come back â†’ same key
* Hotel remembers you using that key

In web apps:

* Browser â†’ Session ID
* Server â†’ Session data
* Cart â†’ Stored against session

## ğŸ§© What Is a Session-Based Cart?

* Each user gets **one cart**
* Cart lives in **server memory**
* Cart is linked using **Session ID**
* No database required (for now)

Perfect for:

* Learning
* MVP
* Interview explanation
* Small applications

# ğŸ—ï¸ Implementation â€“ Step by Step

## âœ… Step 1: Enable Session (VERY IMPORTANT)

### `Program.cs`

```csharp
builder.Services.AddDistributedMemoryCache();

builder.Services.AddSession(options =>
{
    options.IdleTimeout = TimeSpan.FromMinutes(30);
    options.Cookie.HttpOnly = true;
    options.Cookie.IsEssential = true;
});

var app = builder.Build();

app.UseSession();   // âš ï¸ Must be BEFORE MapControllerRoute
```

ğŸ§  Mentor Tip:

> â€œSession middleware nahi lihila tar
> cart zhala tari memory madhe rahnar nahi.â€

## âœ… Step 2: Models

### `Product.cs`

```csharp
public class Product
{
    public int Id { get; set; }
    public string Name { get; set; }
    public decimal Price { get; set; }
}
```

### `CartItem.cs`

```csharp
public class CartItem
{
    public Product Product { get; set; }
    public int Quantity { get; set; }
}
```

## âœ… Step 3: Session Helper (Serialization)

Session stores **string / byte[]**, not objects.

### `SessionExtensions.cs`

```csharp
using System.Text.Json;

public static class SessionExtensions
{
    public static void SetObject<T>(this ISession session, string key, T value)
    {
        session.SetString(key, JsonSerializer.Serialize(value));
    }

    public static T GetObject<T>(this ISession session, string key)
    {
        var value = session.GetString(key);
        return value == null ? default : JsonSerializer.Deserialize<T>(value);
    }
}
```

ğŸ§  Mentor Tip:

> â€œSession madhe object thevaycha asel
> tar JSON madhye convert kara.â€


## âœ… Step 4: Cart Service Interface

### `IShoppingCartService.cs`

```csharp
public interface IShoppingCartService
{
    void AddToCart(Product product);
    void RemoveFromCart(int productId);
    List<CartItem> GetCartItems();
}
```

## âœ… Step 5: Cart Service Implementation (SESSION MAGIC)

### `ShoppingCartService.cs`

```csharp
public class ShoppingCartService : IShoppingCartService
{
    private readonly IHttpContextAccessor _httpContextAccessor;
    private const string CartKey = "CART";

    public ShoppingCartService(IHttpContextAccessor httpContextAccessor)
    {
        _httpContextAccessor = httpContextAccessor;
    }

    private ISession Session => _httpContextAccessor.HttpContext.Session;

    public List<CartItem> GetCartItems()
    {
        return Session.GetObject<List<CartItem>>(CartKey) ?? new List<CartItem>();
    }

    public void AddToCart(Product product)
    {
        var cart = GetCartItems();

        var existingItem = cart.FirstOrDefault(c => c.Product.Id == product.Id);

        if (existingItem != null)
        {
            existingItem.Quantity++;
        }
        else
        {
            cart.Add(new CartItem
            {
                Product = product,
                Quantity = 1
            });
        }

        Session.SetObject(CartKey, cart);
    }

    public void RemoveFromCart(int productId)
    {
        var cart = GetCartItems();
        var item = cart.FirstOrDefault(c => c.Product.Id == productId);

        if (item != null)
        {
            cart.Remove(item);
        }

        Session.SetObject(CartKey, cart);
    }
}
```

ğŸ§  Mentor Insight:

> Singleton service âŒ
> Session gives **per-user cart** automatically

## âœ… Step 6: Register Services in `Program.cs`

```csharp
builder.Services.AddHttpContextAccessor();
builder.Services.AddScoped<IShoppingCartService, ShoppingCartService>();
```

## âœ… Step 7: ShoppingCartController

### `ShoppingCartController.cs`

```csharp
public class ShoppingCartController : Controller
{
    private readonly IShoppingCartService _cartService;

    public ShoppingCartController(IShoppingCartService cartService)
    {
        _cartService = cartService;
    }

    public IActionResult Index()
    {
        var cartItems = _cartService.GetCartItems();
        return View(cartItems);
    }

    public IActionResult AddToCart(int id)
    {
        // Fake product for demo
        var product = new Product
        {
            Id = id,
            Name = "Sample Product " + id,
            Price = 100
        };

        _cartService.AddToCart(product);
        return RedirectToAction("Index");
    }

    public IActionResult RemoveFromCart(int id)
    {
        _cartService.RemoveFromCart(id);
        return RedirectToAction("Index");
    }
}
```

## âœ… Step 8: Cart View

### `Views/ShoppingCart/Index.cshtml`

```html
@model List<CartItem>

<h2>Your Cart</h2>

<table class="table">
    <tr>
        <th>Product</th>
        <th>Qty</th>
        <th>Price</th>
        <th></th>
    </tr>

@foreach (var item in Model)
{
    <tr>
        <td>@item.Product.Name</td>
        <td>@item.Quantity</td>
        <td>@item.Product.Price</td>
        <td>
            <a asp-action="RemoveFromCart"
               asp-route-id="@item.Product.Id"
               class="btn btn-danger">Remove</a>
        </td>
    </tr>
}
</table>
```

## ğŸ§  What Students Should Understand

âœ” Web is stateless
âœ” Session adds memory
âœ” Cart is **per user**, not per app
âœ” Service is clean & testable
âœ” Controller only delegates
âœ” Feature follows MVC + DI + SOLID

## ğŸ¯ Interview-Ready Explanation

> â€œWe used a session-based shopping cart where cart data is serialized and stored in server-side session memory. Each user gets a unique session ID, ensuring cart isolation. Business logic is handled via a cart service injected into the controller using dependency injection.â€



## ğŸ§  Mentor Story

> â€œThink of your Shopping Cart like a **bag** carried by each customer.
> The customer never puts items directly into the bag.
> They ask a **shop assistant (Controller)**.
> The assistant talks to the **store manager (Service)**.
> The manager keeps the bag safely in a **locker (Session)** labeled with the customerâ€™s identity.â€


# 1ï¸âƒ£ High-Level ASCII Architecture Diagram

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Browser  â”‚
â”‚   (User)   â”‚
â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
      â”‚ HTTP Request
      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   MVC Controller   â”‚
â”‚ ShoppingCartCtrl   â”‚
â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â”‚ Dependency Injection
      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   CartService      â”‚
â”‚ (Business Logic)   â”‚
â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â”‚ Uses IHttpContextAccessor
      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚     Session        â”‚
â”‚ (Per User Storage) â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

ğŸ“Œ **Key Insight**

* Only **CartService** knows about Session
* Controller does **not** touch Session
* Each browser â†’ separate Session â†’ separate Cart


# 2ï¸âƒ£ Detailed ASCII Flow (Add To Cart)

```
User Clicks "Add To Cart"
        â”‚
        â–¼
GET /ShoppingCart/AddToCart/2
        â”‚
        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ShoppingCartController     â”‚
â”‚                            â”‚
â”‚ AddToCart(productId)       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚
              â”‚ calls
              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ CartService                â”‚
â”‚                            â”‚
â”‚ GetCart()                  â”‚
â”‚ Add product or increment   â”‚
â”‚ SaveCart()                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚
              â”‚ session access
              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Session                    â”‚
â”‚ CART = JSON                â”‚
â”‚ (Unique per user)          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

# 3ï¸âƒ£ UI â†’ Controller â†’ Service â†’ Session (Step-by-Step Flow)

```
[ UI (Products Page) ]
        |
        | 1. Click "Add To Cart"
        |
        v
[ ShoppingCartController ]
        |
        | 2. Calls _cartService.AddToCart(product)
        |
        v
[ CartService ]
        |
        | 3. Reads CART from Session
        | 4. Updates Cart
        |
        v
[ Session Storage ]
        |
        | 5. Saves updated CART
        |
        v
[ Redirect to Cart Index ]
```

---

# 4ï¸âƒ£ Read Cart Flow (Index Action)

```
Browser â†’ GET /ShoppingCart/Index
        â”‚
        â–¼
Controller.Index()
        â”‚
        â–¼
CartService.GetCart()
        â”‚
        â–¼
Session["CART"]
        â”‚
        â–¼
List<CartItem>
        â”‚
        â–¼
View (ShoppingCart/Index.cshtml)
```

---

# 5ï¸âƒ£ Remove From Cart Flow

```
Click "Remove"
     â”‚
     â–¼
GET /ShoppingCart/RemoveFromCart/1
     â”‚
     â–¼
Controller
     â”‚
     â–¼
CartService.RemoveFromCart(id)
     â”‚
     â–¼
Session updated
     â”‚
     â–¼
Redirect â†’ Index
```

---

# 6ï¸âƒ£ Session Perspective (Very Important Concept)

```
User A (Browser A)        User B (Browser B)
------------------       ------------------
SessionId: A123          SessionId: B456

CART                     CART
-----                    -----
Laptop x 1               Mouse x 2
Mouse x 1                Keyboard x 1
```

ğŸ“Œ **One CartService instance**
ğŸ“Œ **Many Sessions**
ğŸ“Œ **Many Carts**



# 7ï¸âƒ£ One-Line Interview Explanation

> â€œShopping cart is implemented using a session-based CartService injected via DI.
> Each user has an isolated cart because session data is keyed per user session.â€


# 8ï¸âƒ£ Why This Diagram Matters for Students

- âœ” Clear separation of concerns
- âœ” No static data
- âœ” DI-friendly
- âœ” Scales to DB later
- âœ” Same flow works for Web API / React

