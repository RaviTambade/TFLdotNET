# **MVC fundamentals meet real-world distributed architecture**

Imagine you built a **beautiful shopping mall** ğŸ¬.

* Customers (Browser) enter the mall
* They add items to a **shopping basket**
* The basket must **remember items** even if:

  * They go to another counter
  * The mall staff changes
  * Traffic is heavy

Now imagine this mall has **multiple gates (servers)**.

If the basket is kept **inside one gateâ€™s cupboard (In-Memory Session)**:

* Customer enters Gate-1 â†’ basket exists
* Next request goes to Gate-2 â†’ basket is **lost** âŒ

Thatâ€™s exactly what happens when:

> Session state is stored **inside the ASP.NET Web Server**


## ğŸš¨ The Core Problem

ASP.NET Core MVC is **stateless by design**
HTTP is **stateless**
Load balancers send requests to **different servers**

ğŸ‘‰ **Session in memory will NOT work**


## âœ… Solution Principle (Golden Rule)

> **Session State must live OUTSIDE the Web Server**


## ğŸ§© Architectural Options (Real-World)

### ğŸ¥‡ Option 1: **Distributed Cache (Recommended)**

Store session in a **centralized system**:

| Option                   | Use Case                      |
| ------------------------ | ----------------------------- |
| **Redis**                | Production, scalable, fastest |
| SQL Server               | Small / medium apps           |
| Distributed Memory Cache | Learning only                 |


### ğŸ—ï¸ Architecture

```
Browser
   |
Load Balancer
   |
-------------------------
| Web Server A (MVC)   |
| Web Server B (MVC)   |
| Web Server C (MVC)   |
-------------------------
        |
        v
   Redis / SQL Server
   (Session Store)
```

- âœ” Any server can access the same session
- âœ” No session loss
- âœ” Horizontal scaling supported



## ğŸ§ª ASP.NET Core Implementation (Redis Example)

### 1ï¸âƒ£ Install Packages

```bash
dotnet add package Microsoft.Extensions.Caching.StackExchangeRedis
```

### 2ï¸âƒ£ Configure `Program.cs`

```csharp
builder.Services.AddStackExchangeRedisCache(options =>
{
    options.Configuration = "localhost:6379";
    options.InstanceName = "ShoppingCartApp:";
});

builder.Services.AddSession(options =>
{
    options.IdleTimeout = TimeSpan.FromMinutes(30);
    options.Cookie.HttpOnly = true;
    options.Cookie.IsEssential = true;
});

var app = builder.Build();

app.UseSession();
```


### 3ï¸âƒ£ Use Session in CartService

```csharp
public class CartService
{
    private readonly IHttpContextAccessor _httpContextAccessor;

    public CartService(IHttpContextAccessor httpContextAccessor)
    {
        _httpContextAccessor = httpContextAccessor;
    }

    public void AddToCart(int productId)
    {
        var session = _httpContextAccessor.HttpContext.Session;
        var cart = session.GetObject<List<int>>("Cart") ?? new List<int>();
        cart.Add(productId);
        session.SetObject("Cart", cart);
    }
}
```

> ğŸ’¡ Session data is now stored in Redis â€” not in the web server.



## ğŸ¥ˆ Option 2: **Database-Driven Cart (Best Design)**

Instead of Session:

```
UserId â†’ Cart â†’ CartItems â†’ Products
```

âœ” Works across devices
âœ” Survives browser refresh
âœ” Ideal for login-based systems

> Amazon, Flipkart, Swiggy â†’ **NOT session based**



## ğŸ¥‰ Option 3: **Sticky Sessions (âŒ Avoid)**

Load balancer forces user to same server.

Problems:

* Not scalable
* Server crash = session loss
* Cloud-unfriendly


## ğŸ§  Mentor Recommendation (Very Important)

| App Type        | Recommendation              |
| --------------- | --------------------------- |
| Learning / Demo | Distributed Session (Redis) |
| Real E-Commerce | **DB-based Cart**           |
| Microservices   | Token + Cart API            |



## ğŸ” Final Decision Flow

```
Single Server?
   |
   No
   |
Need Scalability?
   |
   Yes
   |
Use Distributed Cache (Redis)
   |
OR
   |
Use Database Cart (Best)
```


> **Never store shopping cart session inside the ASP.NET web server in a multi-server setup.
> Store it in Redis or the Database.**





* ASP.NET Core **Web API Controller**
* **Service layer** (Business logic)
* **Repository layer**
* **JSON Helper** for Serialization / Deserialization
* **JSON file** as data store
* **Dependency Injection flow**
* Microservice boundary


## ğŸ§© ASP.NET Core Microservice â€“ Layered ASCII Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                 CLIENTS                       â”‚
â”‚-----------------------------------------------â”‚
â”‚  Browser | Mobile App | SPA | Other Services  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    |
                    | HTTP (JSON Request)
                    v
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚        ASP.NET CORE WEB API MICROSERVICE       â”‚
â”‚                                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚            API CONTROLLER               â”‚  â”‚
â”‚  â”‚-----------------------------------------â”‚  â”‚
â”‚  â”‚  ProductsController                     â”‚  â”‚
â”‚  â”‚  - GET /api/products                    â”‚  â”‚
â”‚  â”‚  - POST /api/products                   â”‚  â”‚
â”‚  â”‚                                         â”‚  â”‚
â”‚  â”‚  Depends On â†’ IProductService           â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                    |                           â”‚
â”‚                    | Dependency Injection     â”‚
â”‚                    v                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚              SERVICE LAYER               â”‚  â”‚
â”‚  â”‚-----------------------------------------â”‚  â”‚
â”‚  â”‚  ProductService : IProductService        â”‚  â”‚
â”‚  â”‚  - Business Rules                        â”‚  â”‚
â”‚  â”‚  - Validation                            â”‚  â”‚
â”‚  â”‚  - Orchestration                         â”‚  â”‚
â”‚  â”‚                                         â”‚  â”‚
â”‚  â”‚  Depends On â†’ IProductRepository         â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                    |                           â”‚
â”‚                    | Dependency Injection     â”‚
â”‚                    v                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚            REPOSITORY LAYER              â”‚  â”‚
â”‚  â”‚-----------------------------------------â”‚  â”‚
â”‚  â”‚  ProductRepository : IProductRepository â”‚  â”‚
â”‚  â”‚  - Data Access Logic                    â”‚  â”‚
â”‚  â”‚  - No Business Rules                    â”‚  â”‚
â”‚  â”‚                                         â”‚  â”‚
â”‚  â”‚  Depends On â†’ IJsonHelper                â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                    |                           â”‚
â”‚                    | Dependency Injection     â”‚
â”‚                    v                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚           JSON HELPER UTILITY            â”‚  â”‚
â”‚  â”‚-----------------------------------------â”‚  â”‚
â”‚  â”‚  JsonFileHelper : IJsonHelper            â”‚ â”‚
â”‚  â”‚  - Serialize<T>()                        â”‚ â”‚
â”‚  â”‚  - Deserialize<T>()                      â”‚ â”‚
â”‚  â”‚  - File Read / Write                     â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                    |                          â”‚
â”‚                    | File I/O                 â”‚
â”‚                    v                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚              JSON FILE STORE            â”‚  â”‚
â”‚  â”‚-----------------------------------------â”‚  â”‚
â”‚  â”‚  products.json                          â”‚  â”‚
â”‚  â”‚  orders.json                            â”‚  â”‚
â”‚  â”‚  customers.json                         â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    |
                    | HTTP (JSON Response)
                    v
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                 CLIENTS                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```


## ğŸ”„ Request Flow (Step-by-Step)

```
Client
  â†“
Controller
  â†“
Service
  â†“
Repository
  â†“
JsonHelper
  â†“
JSON File
```

```
JSON File
  â†‘
JsonHelper
  â†‘
Repository
  â†‘
Service
  â†‘
Controller
  â†‘
Client
```



## ğŸ§  DI Registration (Mental Model)

```
Controller
   â†“
IProductService  â†’ ProductService
   â†“
IProductRepository â†’ ProductRepository
   â†“
IJsonHelper â†’ JsonFileHelper
```


## ğŸ—ï¸ Typical Folder Structure

```
ProductMicroservice
â”‚
â”œâ”€â”€ Controllers
â”‚   â””â”€â”€ ProductsController.cs
â”‚
â”œâ”€â”€ Services
â”‚   â”œâ”€â”€ IProductService.cs
â”‚   â””â”€â”€ ProductService.cs
â”‚
â”œâ”€â”€ Repositories
â”‚   â”œâ”€â”€ IProductRepository.cs
â”‚   â””â”€â”€ ProductRepository.cs
â”‚
â”œâ”€â”€ Helpers
â”‚   â”œâ”€â”€ IJsonHelper.cs
â”‚   â””â”€â”€ JsonFileHelper.cs
â”‚
â”œâ”€â”€ Models
â”‚   â””â”€â”€ Product.cs
â”‚
â”œâ”€â”€ Data
â”‚   â””â”€â”€ products.json
â”‚
â””â”€â”€ Program.cs
```


> **This JSON-file-based microservice is NOT for production.**
> It is a **teaching microservice** to help students understand:

- âœ” Clean Architecture
- âœ” Dependency Injection
- âœ” Serialization / Deserialization
- âœ” Serviceâ€“Repository separation
- âœ” Microservice boundaries

Later you replace:

```
JSON File â†’ Database / Cloud Storage
```

**without touching the Controller or Service**



## ğŸ”¥ Why This Is a Perfect Teaching Microservice

* No database dependency
* Focus on **architecture**
* Easy to Dockerize
* Easy to convert into:

  * SQL microservice
  * MongoDB microservice
  * Cloud-native microservice

#  **clean, step-by-step way** to create an **ASP.NET Core Web API**.


## 1ï¸âƒ£ Check .NET SDK

```bash
dotnet --version
```

(Ensure .NET 7 / 8 / 6 is installed)

## 2ï¸âƒ£ Create Web API Project (Controller-based)

ğŸ‘‰ **Important**: Use `--no-minimal` to get **Controllers**

```bash
dotnet new webapi -n ProductMicroservice --no-minimal
```

ğŸ“ This creates:

```
ProductMicroservice
â”œâ”€â”€ Controllers
â”‚   â””â”€â”€ WeatherForecastController.cs
â”œâ”€â”€ Program.cs
â”œâ”€â”€ ProductMicroservice.csproj
```



## 3ï¸âƒ£ Go to Project Folder

```bash
cd ProductMicroservice
```


## 4ï¸âƒ£ Run the Application

```bash
dotnet run
```

Open browser:

```
https://localhost:5001/swagger
```

(or the port shown in console)

---

## 5ï¸âƒ£ Add Your Own Controller (CLI Way)

Create a **ProductsController**

```bash
dotnet new controller -n ProductsController -o Controllers
```

This creates:

```
Controllers/ProductsController.cs
```


## 6ï¸âƒ£ Sample ProductsController

```csharp
using Microsoft.AspNetCore.Mvc;

namespace ProductMicroservice.Controllers
{
    [ApiController]
    [Route("api/[controller]")]
    public class ProductsController : ControllerBase
    {
        [HttpGet]
        public IActionResult Get()
        {
            return Ok(new[] { "Laptop", "Mobile", "Tablet" });
        }
    }
}
```

## 7ï¸âƒ£ Test Endpoint

```
GET https://localhost:5001/api/products
```

Response:

```json
["Laptop","Mobile","Tablet"]
```


## 8ï¸âƒ£ Program.cs (Controller Enabled)

Make sure you see:

```csharp
builder.Services.AddControllers();

var app = builder.Build();

app.MapControllers();
```


## 9ï¸âƒ£ Clean Up Default Controller (Optional)

Remove:

```
WeatherForecastController.cs
```


| Goal                 | Command                          |
| -------------------- | -------------------------------- |
| Minimal API          | `dotnet new webapi`              |
| Controller-based API | `dotnet new webapi --no-minimal` |
| Add Controller later | `dotnet new controller`          |

> **Always use controller-based APIs when teaching architecture, DI, and microservices.**





Here is a **clean, simple sample `products.json`** for **Flower products**, perfectly matching your `Product` class.

## ğŸŒ¸ `products.json`

```json
[
  {
    "Id": 1,
    "Name": "Rose",
    "Price": 25.00
  },
  {
    "Id": 2,
    "Name": "Lily",
    "Price": 40.00
  },
  {
    "Id": 3,
    "Name": "Tulip",
    "Price": 35.50
  },
  {
    "Id": 4,
    "Name": "Orchid",
    "Price": 120.00
  },
  {
    "Id": 5,
    "Name": "Sunflower",
    "Price": 15.00
  }
]
```

## âœ… Matches Your C# Model Exactly

```csharp
public class Product
{
    public int Id { get; set; }
    public string Name { get; set; } = string.Empty;
    public decimal Price { get; set; }
}
```

âœ” Property names match
âœ” Decimal values supported
âœ” Ready for serialization/deserialization

---

## ğŸ“ Recommended Folder Placement

```
ProductWebAPI
â”œâ”€â”€ Data
â”‚   â””â”€â”€ products.json
```

 

> JSON files are **excellent for teaching repositories and DI**,
> but **never use them in production** for concurrent systems.



# JsonFileHelper
## **clean, mentor-friendly `JsonFileHelper`** that handles **Serialize & Deserialize** for your **ASP.NET Core Web API microservice**.

This helper is **generic**, reusable, and ideal for your **JSON-file-based repository** teaching model.


## 1ï¸âƒ£ Interface â€“ `IJsonFileHelper`

ğŸ“ **Helpers/IJsonFileHelper.cs**

```csharp
using System.Collections.Generic;

public interface IJsonFileHelper
{
    List<T> ReadFromFile<T>(string filePath);
    void WriteToFile<T>(string filePath, List<T> data);
}
```


## 2ï¸âƒ£ Implementation â€“ `JsonFileHelper`

ğŸ“ **Helpers/JsonFileHelper.cs**

```csharp
using System.Text.Json;

public class JsonFileHelper : IJsonFileHelper
{
    public List<T> ReadFromFile<T>(string filePath)
    {
        if (!File.Exists(filePath))
        {
            return new List<T>();
        }

        var json = File.ReadAllText(filePath);

        if (string.IsNullOrWhiteSpace(json))
        {
            return new List<T>();
        }

        return JsonSerializer.Deserialize<List<T>>(json)
               ?? new List<T>();
    }

    public void WriteToFile<T>(string filePath, List<T> data)
    {
        var options = new JsonSerializerOptions
        {
            WriteIndented = true
        };

        var json = JsonSerializer.Serialize(data, options);
        File.WriteAllText(filePath, json);
    }
}
```

## 3ï¸âƒ£ Register in Dependency Injection

ğŸ“ **Program.cs**

```csharp
builder.Services.AddSingleton<IJsonFileHelper, JsonFileHelper>();
```

## 4ï¸âƒ£ How Repository Uses This Helper (Conceptual)

```
Repository
   â†“
JsonFileHelper
   â†“
products.json
```

Example usage inside a repository:

```csharp
public class ProductRepository : IProductRepository
{
    private readonly IJsonFileHelper _jsonHelper;
    private readonly string _filePath = "Data/products.json";

    public ProductRepository(IJsonFileHelper jsonHelper)
    {
        _jsonHelper = jsonHelper;
    }

    public List<Product> GetAll()
    {
        return _jsonHelper.ReadFromFile<Product>(_filePath);
    }
}
```

### Why this helper is good for teaching

âœ” Separation of concerns
âœ” Repository stays clean
âœ” File handling logic isolated
âœ” Easy to swap JSON â†’ DB later

### Why NOT for production

âŒ No concurrency handling
âŒ No locking
âŒ No transactions


## ğŸ“‚ Suggested Folder Structure

```
ProductWebAPI
â”œâ”€â”€ Helpers
â”‚   â”œâ”€â”€ IJsonFileHelper.cs
â”‚   â””â”€â”€ JsonFileHelper.cs
â”œâ”€â”€ Repositories
â”œâ”€â”€ Services
â”œâ”€â”€ Controllers
â”œâ”€â”€ Models
â”œâ”€â”€ Data
â”‚   â””â”€â”€ products.json
```

> **JsonFileHelper is your â€œtemporary databaseâ€**
> Perfect for learning **DI, Repository, Serialization**, and **Microservices boundaries**.

