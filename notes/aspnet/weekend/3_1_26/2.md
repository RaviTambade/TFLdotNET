# ðŸŽ¯ Goal

```
Client
  â†“
API Gateway (ASP.NET Core + YARP)
  â†“
ProductCatalog / ShoppingCart / OrderProcessing / Shipment
```

No business logic in Gateway.
Only **routing + cross-cutting concerns**.

# ðŸŸ¢ STEP 1: Add YARP Package to API Gateway

Go to **API Gateway project folder**:

```bash
cd src/ApiGateway/ECommerce.ApiGateway
```

Install YARP:

```bash
dotnet add package Yarp.ReverseProxy
```


# ðŸŸ¢ STEP 2: Configure Routes & Clusters (appsettings.json)

ðŸ“„ `appsettings.json` (API Gateway)

```json
{
  "ReverseProxy": {
    "Routes": {
      "productcatalog-route": {
        "ClusterId": "productcatalog-cluster",
        "Match": {
          "Path": "/catalog/{**catch-all}"
        }
      },
      "shoppingcart-route": {
        "ClusterId": "shoppingcart-cluster",
        "Match": {
          "Path": "/cart/{**catch-all}"
        }
      },
      "orderprocessing-route": {
        "ClusterId": "orderprocessing-cluster",
        "Match": {
          "Path": "/orders/{**catch-all}"
        }
      },
      "shipment-route": {
        "ClusterId": "shipment-cluster",
        "Match": {
          "Path": "/shipments/{**catch-all}"
        }
      }
    },

    "Clusters": {
      "productcatalog-cluster": {
        "Destinations": {
          "d1": { "Address": "http://localhost:5001/" }
        }
      },
      "shoppingcart-cluster": {
        "Destinations": {
          "d1": { "Address": "http://localhost:5002/" }
        }
      },
      "orderprocessing-cluster": {
        "Destinations": {
          "d1": { "Address": "http://localhost:5003/" }
        }
      },
      "shipment-cluster": {
        "Destinations": {
          "d1": { "Address": "http://localhost:5004/" }
        }
      }
    }
  }
}
```

ðŸ§  **Teaching insight**

* **Routes** â†’ public URLs
* **Clusters** â†’ internal microservices
* **Destinations** â†’ service instances (scaled later)


# ðŸŸ¢ STEP 3: Register YARP in Program.cs

ðŸ“„ `Program.cs` (API Gateway)

```csharp
var builder = WebApplication.CreateBuilder(args);

builder.Services.AddReverseProxy()
    .LoadFromConfig(builder.Configuration.GetSection("ReverseProxy"));

var app = builder.Build();

app.MapReverseProxy();

app.Run();
```

âœ… Thatâ€™s it.
No controllers needed for routing.

# ðŸŸ¢ STEP 4: Update Microservice Controllers (Consistency)

Ensure each microservice uses **internal routes**.

### ProductCatalog.Api

```csharp
[ApiController]
[Route("api/products")]
public class ProductsController : ControllerBase
{
    [HttpGet]
    public IActionResult GetAll()
    {
        return Ok(new[]
        {
            new { Id = 1, Name = "Laptop", Price = 75000 }
        });
    }
}
```

### ShoppingCart.Api

```csharp
[ApiController]
[Route("api/cart")]
public class CartController : ControllerBase
{
    [HttpPost("add")]
    public IActionResult Add(object item)
    {
        return Ok("Item added");
    }
}
```

# ðŸŸ¢ STEP 5: How Routing Works (Very Important)

### Client Calls

```
GET http://localhost:5000/catalog/api/products
```

### Gateway Maps

```
/catalog/*  â†’ ProductCatalog service
```

### Gateway Forwards Internally

```
http://localhost:5001/api/products
```

ðŸ§  Client **never knows**:

* Service ports
* Service count
* Service location

# ðŸŸ¢ STEP 6: Run the System

Run services in separate terminals:

```bash
dotnet run --project Services/ProductCatalog/ProductCatalog.Api --urls=http://localhost:5001
dotnet run --project Services/ShoppingCart/ShoppingCart.Api --urls=http://localhost:5002
dotnet run --project Services/OrderProcessing/OrderProcessing.Api --urls=http://localhost:5003
dotnet run --project Services/Shipment/Shipment.Api --urls=http://localhost:5004
```

Run Gateway:

```bash
dotnet run --project ApiGateway/ECommerce.ApiGateway --urls=http://localhost:5000
```


# ðŸŸ¢ STEP 7: Test via Browser / Postman

| Client URL                 | Routed To       |
| -------------------------- | --------------- |
| `/catalog/api/products`    | ProductCatalog  |
| `/cart/api/cart/add`       | ShoppingCart    |
| `/orders/api/orders`       | OrderProcessing |
| `/shipments/api/shipments` | Shipment        |

ðŸŽ‰ **Gateway routing is working**

# ðŸ§  Architecture Rules (Mentor Gold)

1. Gateway has **NO controllers for business**
2. Routing is **configuration-driven**
3. Services can scale independently
4. Replace `localhost` with:

   * Kubernetes service DNS
   * Service Fabric naming
5. Zero code change in Gateway
